---
title: '都9012年了,你还在手动部署代码吗(二)'
date: 2019-05-16 10:59:50
tags:
---
#### 前言

在写完基于 Webhooks 的["第一篇《都9012年了,你还在手动部署代码吗》"](https://juejin.im/post/5cab1a9ee51d452b1162526a)之后,有同学评论到"都9012年了,你好歹用个 docker 啊""你这怎么多机部署啊"....于是我决定出一篇基于 Docker 的自动部署文章 (:

这是一篇利用 Docker 和 Gitlab-CI 的学习自动部署和实践的笔记,如果您是 Docker 资深玩家,跪求大佬不要吊锤;如果您是萌新,刚开始 Docker 学习之旅,那么希望笔记中的理解和操作能够对您有所帮助.

然鹅,饱和的需求和人的惰性让第二篇拖到了今天ORZ!!! ~~王者峡谷一时爽,一直王者一直爽~~

<!-- more -->

ps: 组里大佬推荐阅读了[Front-end Developer Handbook 2019 - Learn the entire JavaScript, CSS and HTML development practice!](https://frontendmasters.com/books/front-end-handbook/2019/) 用它自己的话说: 这是一份任何人都可以用来了解前端开发实践的指南。 它概括地描绘了2019年前端工程的开发实践之路：如何学习前端以及开发实践时使用到了哪些工具。([文章Github](https://github.com/FrontendMasters/front-end-handbook-2019)已有2k多Star,欢迎大家阅读补充 Star! Books 由 Frontend Masters 赞助,从2016年起, Frontend Masters 每年都会根据该年的前端发展编写书籍文章汇总,你可以点击[这里](https://frontendmasters.com/books/)查看具体~)

~~我fork了一份源码仓库利用下班时间将文章翻译成中文提供zh-CN版本并提交了PR,希望能帮助到更多的同学阅读文章学习前端.欢迎有空闲的同学一起参与翻译和校对工作TAT~~



#### 背景

同上一篇文章,手动太麻烦,想要偷懒.

#### 目标

当我在本地开发完成 push 后,集成环境能够自动完成部署测试打包上传 FTP

##### 前置条件

1. 位于内网服务器的 Gitlab 源码仓库(版本支持 Gitlab-CI )
2. 位于内网服务器的集成测试环境(能够 Pull 远程仓库代码)
3. 集成测试服务器能够安装 Docker



#### 行动

工欲善其事必先利其器,开始行动前有必要理解一波 Docker 和 Gitlab-CI 自动部署原理;

这波要理解的东西有点多,不过不慌,我们一个一个来 !



##### [Docker](http://www.jsdaima.com/blog/177.html)

`Docker 属于 Linux 容器的一种封装,提供简单易用的容器使用接口. 它将应用程序与该程序的依赖,打包在一个文件里面. 运行这个文件,就会生成一个虚拟容器. 程序在这个虚拟容器里运行,就好像在真实的物理机上运行一样. 有了 Docker,就不用担心环境问题.`  

Docker容器常常拿来和虚拟机VM相比较,提到VM,就不得不说....别提了,我还记得当年在大学的虚拟机课程,等虚拟机启动的时间里,老师可以寂寞地抽完几根烟...

Docker优势:

- 更快速的交付和部署
- 高效的部署和扩容
- 更高的资源利用率
- 更简单的管理

说白了好用就完事了,特别是微服务兴起的今天,docker还是有必要掌握一波的 !

有几个概念我们需要理解一下:

- Image(镜像)
- Container(容器): 运行镜像
- Repository(仓库): 储存镜像

我们首先根据文档在集成服务器上安装Docker => [CentOS7上安装Docker](https://yeasy.gitbooks.io/docker_practice/content/install/centos.html)



##### 理解Gitlab-CI自动部署原理

`本地仓库 -> (push提交代码) -> 远程仓库(Gitlab-CI) -> (通知注册完成的runner) -> 集成服务器(runner Executor执行命令)-> 打包上传FTP `



##### 配置远程仓库Gitlab-CI

理解完原理后我们来配置(搞定)Gitlab-CI(Gitlab-8.0版本以后默认集成Gitlab-CI):

找到项目 Project 的 Settings 中的 CI/CD, 点击 Runners settings.这时你会发现两种 Runners:

- **Shared Runners**: 管理员才有资格创建的所有工程都能使用的 Runner
- **Specific Runners**: 拥有访问权限的人为指定工程创建的 Runner

我们可以把 Gitlab-CI 和 Runner 看做工厂和工人的关系, 工人在工厂里先注册, 工厂开工的时候通知工人干活 ~

这里我们使用 Specific Runner, 记住 Specific Runner 配置里的 **URL** 和 **token**, 等下我们就是利用这两个参数在集成服务器配置 Runner 和 Gitlab-CI 建立联系 !



##### 集成服务器(宿主机)配置

前面我们已经在集成服务器上装好了Docker,现在我们需要用 Docker 安装 Gitlab-runner .



#### 结果


